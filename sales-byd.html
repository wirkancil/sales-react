<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alex Tan - BYD Senior Consultant</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #f3f4f6;
            background-image:
                radial-gradient(at 0% 0%, hsla(192, 100%, 96%, 1) 0, transparent 50%),
                radial-gradient(at 50% 100%, hsla(210, 100%, 96%, 1) 0, transparent 50%);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* BYD Brand Color Approximation */
        .bg-byd-teal {
            background-color: #0095A8;
        }

        .text-byd-teal {
            color: #0095A8;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        /* Chat Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-bubble {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .typing-dot {
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        .ai-gradient {
            background: linear-gradient(135deg, #0095A8 0%, #6366f1 100%);
        }
    </style>
</head>

<body class="text-gray-800 min-h-screen flex flex-col items-center justify-center py-8 px-4">

    <!-- Background Decorative Elements -->
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
        <div
            class="absolute top-[-10%] right-[-10%] w-96 h-96 bg-teal-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob">
        </div>
        <div
            class="absolute bottom-[-10%] left-[-10%] w-96 h-96 bg-blue-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-2000">
        </div>
    </div>

    <!-- Main Container -->
    <main class="w-full max-w-md mx-auto">

        <!-- Header / Profile -->
        <div class="text-center mb-8">
            <div class="relative inline-block">
                <img src="https://images.unsplash.com/photo-1560250097-0b93528c311a?ixlib=rb-4.0.3&auto=format&fit=crop&w=256&q=80"
                    alt="Profile" class="w-28 h-28 rounded-full border-4 border-white shadow-xl mx-auto object-cover"
                    onerror="this.src='https://ui-avatars.com/api/?name=Alex+Tan&background=0D8ABC&color=fff&size=128'">
                <div class="absolute bottom-0 right-1 bg-green-500 w-6 h-6 rounded-full border-4 border-gray-50"
                    title="Online"></div>
            </div>

            <h1 class="text-2xl font-bold mt-4 text-gray-900">Alex Tan</h1>
            <p class="text-gray-500 text-sm font-medium uppercase tracking-wide">Senior BYD EV Consultant</p>
            <p class="text-xs text-gray-400 mt-1">Helping you build your electric dreams ‚ö°</p>

            <!-- Social Stats / Trust Badges -->
            <div class="flex justify-center gap-4 mt-4 text-sm text-gray-600">
                <span class="flex items-center gap-1"><i class="fas fa-star text-yellow-400"></i> 4.9/5 Rating</span>
                <span class="flex items-center gap-1"><i class="fas fa-car text-byd-teal"></i> 500+ Delivered</span>
            </div>
        </div>

        <!-- Primary Actions (Sticky feel) -->
        <div class="grid grid-cols-2 gap-3 mb-6">
            <a href="#" onclick="openModal('whatsapp')"
                class="col-span-2 bg-green-500 hover:bg-green-600 text-white py-3.5 px-4 rounded-xl shadow-lg flex items-center justify-center gap-2 font-semibold transition-all transform hover:scale-[1.02]">
                <i class="fab fa-whatsapp text-xl"></i> Chat on WhatsApp
            </a>
            <a href="tel:+1234567890"
                class="bg-white hover:bg-gray-50 text-gray-800 py-3 px-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-center gap-2 font-medium transition-colors">
                <i class="fas fa-phone-alt text-byd-teal"></i> Call Now
            </a>
            <a href="#" onclick="copyLink()" id="copyBtn"
                class="bg-white hover:bg-gray-50 text-gray-800 py-3 px-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-center gap-2 font-medium transition-colors">
                <i class="fas fa-share-nodes text-byd-teal"></i> Share
            </a>
        </div>

        <!-- Main Links List -->
        <div class="flex flex-col gap-4 relative z-10">

            <!-- Test Drive Highlight -->
            <button onclick="openTestDriveModal()"
                class="btn-hover glass-card w-full p-1 rounded-xl group text-left relative overflow-hidden">
                <div
                    class="absolute inset-0 bg-gradient-to-r from-teal-500 to-blue-600 opacity-10 group-hover:opacity-20 transition-opacity">
                </div>
                <div class="bg-white/50 p-4 rounded-lg flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div
                            class="bg-gradient-to-br from-teal-500 to-blue-600 w-10 h-10 rounded-full flex items-center justify-center text-white shadow-md">
                            <i class="fas fa-steering-wheel"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800">Book a Test Drive</h3>
                            <p class="text-xs text-gray-500">Experience the future today</p>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400 group-hover:translate-x-1 transition-transform"></i>
                </div>
            </button>

            <!-- Model: BYD SEAL -->
            <button onclick="openProductDrawer('seal')"
                class="btn-hover glass-card w-full p-4 rounded-xl flex items-center justify-between group bg-white text-left">
                <div class="flex items-center gap-4">
                    <img src="byd_seal.png" alt="BYD Seal"
                        class="w-16 h-10 object-cover rounded-md shadow-sm bg-gray-200"
                        onerror="this.src='https://via.placeholder.com/64x40?text=SEAL'">
                    <div>
                        <h3 class="font-bold text-gray-800">BYD SEAL</h3>
                        <p class="text-xs text-green-600 font-medium">üèÜ Best Seller ‚Ä¢ Performance</p>
                    </div>
                </div>
                <i class="fas fa-chevron-right text-gray-300 group-hover:text-byd-teal transition-colors"></i>
            </button>

            <!-- Model: BYD ATTO 3 -->
            <button onclick="openProductDrawer('atto3')"
                class="btn-hover glass-card w-full p-4 rounded-xl flex items-center justify-between group bg-white text-left">
                <div class="flex items-center gap-4">
                    <img src="byd_atto3.png" alt="BYD Atto 3"
                        class="w-16 h-10 object-cover rounded-md shadow-sm bg-gray-200"
                        onerror="this.src='https://via.placeholder.com/64x40?text=ATTO3'">
                    <div>
                        <h3 class="font-bold text-gray-800">BYD ATTO 3</h3>
                        <p class="text-xs text-gray-500">Premium SUV</p>
                    </div>
                </div>
                <i class="fas fa-chevron-right text-gray-300 group-hover:text-byd-teal transition-colors"></i>
            </button>

            <!-- Model: BYD DOLPHIN -->
            <button onclick="openProductDrawer('dolphin')"
                class="btn-hover glass-card w-full p-4 rounded-xl flex items-center justify-between group bg-white text-left">
                <div class="flex items-center gap-4">
                    <img src="byd_dolphin.png" alt="BYD Dolphin"
                        class="w-16 h-10 object-cover rounded-md shadow-sm bg-gray-200"
                        onerror="this.src='https://via.placeholder.com/64x40?text=DOLPHIN'">
                    <div>
                        <h3 class="font-bold text-gray-800">BYD DOLPHIN</h3>
                        <p class="text-xs text-gray-500">Agile Hatchback</p>
                    </div>
                </div>
                <i class="fas fa-chevron-right text-gray-300 group-hover:text-byd-teal transition-colors"></i>
            </button>

            <!-- Resources Section Divider -->
            <div class="flex items-center gap-4 my-2">
                <div class="h-px bg-gray-300 flex-1"></div>
                <span class="text-xs font-bold text-gray-400 uppercase">Resources</span>
                <div class="h-px bg-gray-300 flex-1"></div>
            </div>

            <!-- Brochure Download -->
            <a href="#"
                class="btn-hover bg-white w-full p-4 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4 group">
                <div
                    class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-600 group-hover:bg-byd-teal group-hover:text-white transition-colors">
                    <i class="fas fa-file-pdf"></i>
                </div>
                <div class="flex-1">
                    <h3 class="font-medium text-gray-800">Download E-Brochures</h3>
                    <p class="text-xs text-gray-500">Specs & Pricing Lists</p>
                </div>
                <i class="fas fa-download text-gray-300"></i>
            </a>

            <!-- Location -->
            <a href="https://maps.google.com" target="_blank"
                class="btn-hover bg-white w-full p-4 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4 group">
                <div
                    class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-600 group-hover:bg-red-500 group-hover:text-white transition-colors">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <div class="flex-1">
                    <h3 class="font-medium text-gray-800">Visit Showroom</h3>
                    <p class="text-xs text-gray-500">300 BYD Avenue, Tech City</p>
                </div>
                <i class="fas fa-external-link-alt text-gray-300"></i>
            </a>

        </div>

        <!-- Footer -->
        <footer class="mt-12 text-center pb-4">
            <div class="flex justify-center gap-6 mb-6">
                <a href="#" class="text-gray-400 hover:text-pink-600 text-2xl transition-colors"><i
                        class="fab fa-instagram"></i></a>
                <a href="#" class="text-gray-400 hover:text-blue-600 text-2xl transition-colors"><i
                        class="fab fa-facebook"></i></a>
                <a href="#" class="text-gray-400 hover:text-black text-2xl transition-colors"><i
                        class="fab fa-tiktok"></i></a>
                <a href="#" class="text-gray-400 hover:text-blue-500 text-2xl transition-colors"><i
                        class="fab fa-linkedin"></i></a>
            </div>
            <p class="text-xs text-gray-400">¬© 2024 Alex Tan. Independent BYD Sales Consultant.</p>
            <div class="mt-2">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/90/BYD_Auto_Logo.svg/2560px-BYD_Auto_Logo.svg.png"
                    alt="BYD Logo" class="h-4 mx-auto opacity-50 grayscale">
            </div>
        </footer>
    </main>

    <!-- ‚ú® AI FAB (Floating Action Button) ‚ú® -->
    <button onclick="openAIChat()"
        class="fixed bottom-6 right-6 z-50 w-14 h-14 rounded-full ai-gradient shadow-2xl flex items-center justify-center text-white hover:scale-110 transition-transform group hover:shadow-[0_0_20px_rgba(0,149,168,0.5)]">
        <i class="fas fa-sparkles text-xl group-hover:rotate-12 transition-transform"></i>
        <span
            class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full animate-pulse shadow-sm border border-white">NEW</span>
    </button>

    <!-- Test Drive Modal -->
    <div id="testDriveModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm transition-opacity"
            onclick="closeTestDriveModal()"></div>
        <div class="absolute bottom-0 sm:top-1/2 sm:left-1/2 sm:bottom-auto sm:-translate-x-1/2 sm:-translate-y-1/2 w-full sm:w-96 bg-white rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl transform transition-transform duration-300 translate-y-full sm:translate-y-0"
            id="modalPanel">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Book Test Drive</h2>
                <button onclick="closeTestDriveModal()" class="text-gray-400 hover:text-gray-600"><i
                        class="fas fa-times text-xl"></i></button>
            </div>
            <form onsubmit="submitForm(event)" class="flex flex-col gap-4">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1">Select Model</label>
                    <select
                        class="w-full mt-1 p-3 bg-gray-50 border border-gray-200 rounded-xl text-gray-700 focus:outline-none focus:border-teal-500">
                        <option>BYD SEAL</option>
                        <option>BYD ATTO 3</option>
                        <option>BYD DOLPHIN</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1">Your Name</label>
                    <input type="text" required placeholder="John Doe"
                        class="w-full mt-1 p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:border-teal-500">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1">Phone / WhatsApp</label>
                    <input type="tel" required placeholder="+1 234..."
                        class="w-full mt-1 p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:border-teal-500">
                </div>
                <button type="submit"
                    class="mt-2 w-full bg-black text-white font-bold py-4 rounded-xl hover:bg-gray-800 transition-colors">Request
                    Appointment</button>
            </form>
        </div>
    </div>

    <!-- Product Detail Drawer -->
    <div id="productDrawer" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity" onclick="closeProductDrawer()">
        </div>
        <div id="productDrawerPanel"
            class="absolute right-0 top-0 h-full w-[85%] sm:w-[75%] max-w-md bg-white shadow-2xl transform transition-transform duration-300 translate-x-full overflow-y-auto custom-scrollbar">
            <div class="min-h-full flex flex-col relative">
                <div class="absolute top-4 right-4 z-10">
                    <button onclick="closeProductDrawer()"
                        class="bg-white/80 backdrop-blur rounded-full p-2 text-gray-800 shadow-md hover:bg-gray-100"><i
                            class="fas fa-times"></i></button>
                </div>
                <div id="drawerContent"></div>
                <div class="mt-auto sticky bottom-0 p-4 bg-white/95 border-t border-gray-100 backdrop-blur">
                    <button onclick="closeProductDrawer(); setTimeout(openTestDriveModal, 300)"
                        class="w-full bg-byd-teal text-white font-bold py-3 rounded-xl shadow-lg hover:bg-teal-700 transition-colors">I'm
                        Interested</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ú® AI CHAT MODAL (OVERLAY WIDGET) ‚ú® -->
    <div id="aiChatModal" class="fixed z-[60] hidden inset-0 sm:inset-auto sm:bottom-6 sm:right-6">
        <!-- Backdrop (Mobile Only) -->
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity sm:hidden" onclick="closeAIChat()">
        </div>

        <!-- Chat Panel -->
        <div id="aiChatPanel"
            class="absolute bottom-0 w-full sm:w-[380px] sm:relative h-[85vh] sm:h-[550px] bg-gray-50 rounded-t-2xl sm:rounded-2xl shadow-2xl transform transition-transform duration-300 translate-y-[110%] flex flex-col overflow-hidden border border-gray-100/50">

            <!-- Chat Header -->
            <div class="ai-gradient p-4 flex items-center justify-between shrink-0 cursor-pointer"
                onclick="toggleChatMinimize()">
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-white border border-white/30">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-white text-lg">Alex's AI Assistant</h3>
                        <p class="text-xs text-blue-100 flex items-center gap-1"><span
                                class="w-2 h-2 rounded-full bg-green-400"></span> Online</p>
                    </div>
                </div>
                <button onclick="closeAIChat(); event.stopPropagation();"
                    class="text-white/80 hover:text-white transition-colors">
                    <i class="fas fa-chevron-down text-xl"></i>
                </button>
            </div>

            <!-- Chat Area -->
            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar bg-gray-50">
                <!-- Welcome Message -->
                <div class="flex items-start gap-2.5 chat-bubble">
                    <div
                        class="w-8 h-8 rounded-full ai-gradient flex items-center justify-center text-white text-xs shrink-0">
                        AI</div>
                    <div class="bg-white border border-gray-200 p-3 rounded-2xl rounded-tl-none shadow-sm max-w-[85%]">
                        <p class="text-sm text-gray-800">Hi! üëã I'm Alex's digital twin. I know everything about the BYD
                            Seal, Atto 3, and Dolphin. What are you looking for in a car?</p>
                    </div>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="p-3 pb-8 sm:pb-3 bg-white border-t border-gray-200 shrink-0">
                <form onsubmit="handleChatSubmit(event)" class="flex gap-2">
                    <input type="text" id="userChatInput" placeholder="Ask about range..."
                        class="flex-1 bg-gray-100 text-gray-800 text-sm rounded-full px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 border-none">
                    <button type="submit" id="sendChatBtn"
                        class="w-12 h-12 rounded-full ai-gradient text-white flex items-center justify-center hover:shadow-lg transition-shadow shrink-0">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
                <p class="text-[10px] text-center text-gray-400 mt-2">Powered by Gemini AI ‚ú®</p>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast"
        class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg transition-all duration-300 opacity-0 pointer-events-none z-[60] flex items-center gap-2">
        <i class="fas fa-check-circle text-green-400"></i>
        <span id="toastMsg">Action Successful</span>
    </div>

    <script>
        // --- Gemini API Configuration ---
        const apiKey = ""; // Replaced at runtime

        // --- Data for Product Drawer & AI ---
        const carData = {
            seal: {
                name: "BYD SEAL",
                tagline: "Dynamic Aesthetic",
                image: "byd_seal.png",
                description: "The BYD SEAL is a masterpiece of ocean aesthetics. It is a sporty performance sedan with 570km range, 0-100km/h in 3.8s, and advanced CTB (Cell-to-Body) technology.",
                specs: [
                    { label: "Range", value: "570km" },
                    { label: "0-100km/h", value: "3.8s" },
                    { label: "Battery", value: "82.5 kWh" },
                    { label: "Type", value: "Sedan" }
                ],
                price: "Premium Pricing"
            },
            atto3: {
                name: "BYD ATTO 3",
                tagline: "Energetic SUV",
                image: "byd_atto3.png",
                description: "The BYD ATTO 3 is our best-selling premium SUV. It features a fitness-inspired interior, panoramic sunroof, and a spacious cabin perfect for families.",
                specs: [
                    { label: "Range", value: "420km" },
                    { label: "0-100km/h", value: "7.3s" },
                    { label: "Battery", value: "60.48 kWh" },
                    { label: "Type", value: "SUV" }
                ],
                price: "Mid-Range"
            },
            dolphin: {
                name: "BYD DOLPHIN",
                tagline: "Pure Electric Hatch",
                image: "byd_dolphin.png",
                description: "The BYD DOLPHIN is an agile, fun hatchback. Compact yet surprisingly spacious, it is the perfect entry into EV ownership with great city maneuverability.",
                specs: [
                    { label: "Range", value: "427km" },
                    { label: "0-100km/h", value: "7.0s" },
                    { label: "Battery", value: "60.48 kWh" },
                    { label: "Type", value: "Hatchback" }
                ],
                price: "Entry Level"
            }
        };

        // --- ‚ú® GEMINI FEATURE 1: TEXT CHAT ---
        async function callGeminiChat(userMessage) {
            const systemPrompt = `You are an AI Sales Assistant for Alex Tan, a BYD consultant.
            Your Goal: Help users choose a car from this list: ${JSON.stringify(carData)}.
            
            Rules:
            1. Be concise (max 2-3 sentences).
            2. Be friendly and professional.
            3. Use emojis occasionally.
            4. If they ask for price, say "Please contact Alex directly for the latest promotions."
            5. Always try to steer them towards booking a test drive.
            
            User Query: ${userMessage}`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: systemPrompt }] }]
                    })
                });

                if (!response.ok) throw new Error("API Error");
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error(error);
                return "I'm having trouble connecting to the server right now. Please try WhatsApp instead!";
            }
        }

        // --- ‚ú® GEMINI FEATURE 2: TTS AUDIO TOUR ---
        async function generateAudioTour(modelKey) {
            const car = carData[modelKey];
            const btn = document.getElementById('audioTourBtn');
            const icon = btn.querySelector('i');
            const textSpan = btn.querySelector('span');

            // Loading State
            const originalText = textSpan.innerText;
            textSpan.innerText = "Generating Audio...";
            icon.className = "fas fa-spinner fa-spin";
            btn.disabled = true;

            const textToSay = `Welcome to the ${car.name}. ${car.description}. It features a range of ${car.specs[0].value} and accelerates to 100 in ${car.specs[1].value}. Book a test drive with Alex today!`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: textToSay }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } }
                        }
                    })
                });

                if (!response.ok) throw new Error("TTS Error");
                const data = await response.json();
                const audioContent = data.candidates[0].content.parts[0].inlineData.data;

                // Play Audio
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const arrayBuffer = Uint8Array.from(atob(audioContent), c => c.charCodeAt(0)).buffer;
                const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                const source = audioCtx.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(audioCtx.destination);
                source.start(0);

                // UI Feedback during playback
                textSpan.innerText = "Playing Audio Tour...";
                icon.className = "fas fa-volume-up animate-pulse";

                source.onended = () => {
                    textSpan.innerText = originalText;
                    icon.className = "fas fa-headphones-alt";
                    btn.disabled = false;
                };

            } catch (error) {
                console.error(error);
                showToast("Audio generation failed");
                textSpan.innerText = originalText;
                icon.className = "fas fa-headphones-alt";
                btn.disabled = false;
            }
        }

        // --- Chat UI Logic ---
        const chatMessages = document.getElementById('chatMessages');
        const aiChatModal = document.getElementById('aiChatModal');
        const aiChatPanel = document.getElementById('aiChatPanel');

        function openAIChat() {
            aiChatModal.classList.remove('hidden');
            // Small timeout to allow display:block to apply before animating opacity/transform
            setTimeout(() => {
                aiChatPanel.style.transform = 'translateY(0)';
            }, 10);
        }

        function closeAIChat() {
            aiChatPanel.style.transform = 'translateY(110%)';
            setTimeout(() => {
                aiChatModal.classList.add('hidden');
            }, 300);
        }

        function toggleChatMinimize() {
            // Optional: Add minimize functionality logic here if needed in future
        }

        async function handleChatSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('userChatInput');
            const message = input.value.trim();
            if (!message) return;

            // 1. Add User Message
            appendMessage('user', message);
            input.value = '';

            // 2. Show Typing Indicator
            const loadingId = appendLoading();

            // 3. Call API
            const aiResponse = await callGeminiChat(message);

            // 4. Remove Loading & Add AI Message
            removeLoading(loadingId);
            appendMessage('ai', aiResponse);
        }

        function appendMessage(role, text) {
            const div = document.createElement('div');
            div.className = `flex items-start gap-2.5 chat-bubble ${role === 'user' ? 'flex-row-reverse' : ''}`;

            const avatar = role === 'ai'
                ? '<div class="w-8 h-8 rounded-full ai-gradient flex items-center justify-center text-white text-xs shrink-0">AI</div>'
                : '<div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 text-xs shrink-0"><i class="fas fa-user"></i></div>';

            const bubbleClass = role === 'ai'
                ? 'bg-white border border-gray-200 text-gray-800 rounded-tl-none'
                : 'bg-indigo-600 text-white rounded-tr-none';

            div.innerHTML = `
                ${avatar}
                <div class="${bubbleClass} p-3 rounded-2xl shadow-sm max-w-[85%] text-sm">
                    <p>${text}</p>
                </div>
            `;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function appendLoading() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex items-start gap-2.5 chat-bubble";
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full ai-gradient flex items-center justify-center text-white text-xs shrink-0">AI</div>
                <div class="bg-white border border-gray-200 p-4 rounded-2xl rounded-tl-none shadow-sm flex gap-1">
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                </div>
            `;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return id;
        }

        function removeLoading(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        // --- Drawer Logic (Updated) ---
        const productDrawer = document.getElementById('productDrawer');
        const productDrawerPanel = document.getElementById('productDrawerPanel');
        const drawerContent = document.getElementById('drawerContent');

        function openProductDrawer(modelId) {
            const data = carData[modelId];
            if (!data) return;

            let specsHtml = data.specs.map(spec => `
                <div class="bg-gray-50 p-2 rounded-lg text-center border border-gray-100">
                    <p class="text-[10px] text-gray-500 uppercase font-bold">${spec.label}</p>
                    <p class="text-sm font-bold text-gray-800">${spec.value}</p>
                </div>
            `).join('');

            drawerContent.innerHTML = `
                <div class="relative h-48 w-full">
                    <img src="${data.image}" class="w-full h-full object-cover" alt="${data.name}">
                    <div class="absolute inset-0 bg-gradient-to-t from-white via-transparent to-transparent"></div>
                    
                    <!-- ‚ú® AUDIO TOUR BUTTON ‚ú® -->
                    <button id="audioTourBtn" onclick="generateAudioTour('${modelId}')" class="absolute bottom-4 right-4 bg-white/90 backdrop-blur text-indigo-600 px-3 py-2 rounded-full text-xs font-bold shadow-lg flex items-center gap-2 hover:bg-white transition-colors">
                        <i class="fas fa-headphones-alt"></i> <span>Listen to Tour</span>
                    </button>
                </div>
                
                <div class="px-5 pt-2 pb-6">
                    <div class="mb-4">
                        <span class="inline-block px-2 py-1 bg-teal-100 text-teal-700 text-xs font-bold rounded-md mb-1">${data.tagline}</span>
                        <h2 class="text-2xl font-bold text-gray-900 leading-tight">${data.name}</h2>
                        <p class="text-gray-500 text-sm mt-1 font-medium">${data.price}</p>
                    </div>

                    <div class="grid grid-cols-2 gap-2 mb-6">
                        ${specsHtml}
                    </div>

                    <div class="prose prose-sm">
                        <h3 class="text-sm font-bold text-gray-900 uppercase mb-2">Overview</h3>
                        <p class="text-gray-600 text-sm leading-relaxed">${data.description}</p>
                    </div>
                </div>
            `;

            productDrawer.classList.remove('hidden');
            setTimeout(() => {
                productDrawerPanel.classList.remove('translate-x-full');
            }, 10);
        }

        function closeProductDrawer() {
            productDrawerPanel.classList.add('translate-x-full');
            setTimeout(() => {
                productDrawer.classList.add('hidden');
            }, 300);
        }

        // --- Existing Test Drive & Toast Logic ---
        const modal = document.getElementById('testDriveModal');
        const modalPanel = document.getElementById('modalPanel');

        function openTestDriveModal() {
            modal.classList.remove('hidden');
            setTimeout(() => {
                if (window.innerWidth < 640) {
                    modalPanel.style.transform = 'translateY(0)';
                }
            }, 10);
        }

        function closeTestDriveModal() {
            if (window.innerWidth < 640) {
                modalPanel.style.transform = 'translateY(100%)';
                setTimeout(() => { modal.classList.add('hidden'); }, 300);
            } else {
                modal.classList.add('hidden');
            }
        }

        function submitForm(e) {
            e.preventDefault();
            closeTestDriveModal();
            showToast("Request Sent! I'll be in touch.");
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toastMsg');
            toastMsg.innerText = message;
            toast.classList.remove('opacity-0', 'translate-y-[-20px]');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-[-20px]');
            }, 3000);
        }

        function copyLink() {
            const textArea = document.createElement("textarea");
            textArea.value = window.location.href;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showToast("Profile Link Copied!");
            } catch (err) { showToast("Failed to copy"); }
            document.body.removeChild(textArea);
        }

        function openModal(type) {
            if (type === 'whatsapp') {
                window.open('https://wa.me/1234567890?text=Hi%20Alex,%20I%27m%20interested%20in%20a%20BYD%20car.', '_blank');
            }
        }
    </script>
</body>

</html>